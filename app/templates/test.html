<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #main-video {
            width: 1024px;
            margin: auto;
        }

        .video-player {
            display: flex;
        }
    </style>
    <script>
        let state = {
            "time": 0,
            "state": "paused"
        };

        let firstTime = true;
        let userModified = false;

        /**
         * Apply state on video.
         */
        function update() {
            let video = document.getElementById("main-video");
            if (state.time - 500.0 / 60.0 > video.currentTime || state.time + 500.0 / 60.0 < video.currentTime) {
                video.currentTime = state.time;
            }
            if (state.state == "paused") {
                video.pause();
            } else {
                video.play();
            }
        }

        /**
         * Play or pause video.
         */
        function toggle() {
            if (state.state == "paused") {
                state.state = "playing";
            } else {
                state.state = "paused";
            }
            userModified = true;
            update();
        }

        /**
         * Change current time of video.
         */
        function jumpTo(time) {
            state.time = time * 60.0;
            userModified = true;
            update();
        }

        /**
         * Sync video state with server.
         */
        async function sync() {
            // We aren't a viewer yet
            // Time to be up-to-date
            // And to not push our state
            // (which is default state)
            if (firstTime) {
                firstTime = false;
                let data = await fetch('http://localhost:5000/sync/', {
                    method: "GET",
                    mode: "cors",
                    headers: { "Content-Type": "application/json" },
                });
                let json = await data.json();
                console.log(json);
                state = json;
                setInterval(() => {
                    sync();
                }, 500);
            } else {
                // Get state first
                // If current state is different than mine
                // Just apply it
                let data = await fetch('http://localhost:5000/sync/', {
                    method: "GET",
                    mode: "cors",
                    headers: { "Content-Type": "application/json" },
                });
                let json = await data.json();
                let changed = false;
                if (state.time - 500.0 / 60.0 > json["time"] || state.time + 500.0 / 60.0 < json["time"]) {
                    changed = true;
                }
                if (state.state != json["state"]) {
                    changed = true;
                }
                // If remote state changed
                // AND IF user do not make a  change
                if (changed && !userModified) {
                    state = json;
                    update();
                    // End function 
                    return;
                } else {
                    // Okay we can safely
                    // push our state
                    fetch('http://localhost:5000/sync/', {
                        method: "POST",
                        mode: "cors",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(state)
                    });
                    userModified = false;
                }
            }
            update();
        }
        sync();

        async function buildStuff() {
            let data = await fetch('http://localhost:5000/users/', {
                method: "GET",
                mode: "cors",
                headers: { "Content-Type": "application/json" },
            });
            let json = await data.json();
            console.log(json)
            
            let list = document.createElement("ul");
            for (let i = 0; i < json.length; i++) {
                let el = document.createElement("li");
                el.innerText = json[i]["name"];
                list.appendChild(el);
            };
            document.body.appendChild(list);
        }
    </script>
</head>

<body onLoad="buildStuff()">
    <div class="video-player">
        <video id="main-video" onLoad="/*sync()*/">
            <source src="testing-video.mp4" />
        </video>
    </div>
    <button onClick="toggle()">Play</button>
    <button onClick="jumpTo(10)">Jump to 10</button>
    <button onClick="jumpTo(20)">Jump to 20</button>
    <button onClick="jumpTo(25)">Jump to 25</button>
    <form method="POST" action="api.weebinator.org/users/">
        <input required>
    </form>
</body>

</html>